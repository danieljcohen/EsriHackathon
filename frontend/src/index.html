<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>ArcGIS Care</title>
    <link rel="icon" href="./images/hospital.png" />
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      .esri-popup-container {
        width: 400px;
        height: 300px;
      }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.30/"></script>
    <script>
      require(['esri/Map', 'esri/views/MapView', 'esri/layers/VectorTileLayer', 'esri/Graphic', 'esri/layers/GraphicsLayer', 'esri/widgets/Popup'], (
        Map,
        MapView,
        VectorTileLayer,
        Graphic,
        GraphicsLayer,
        Popup,
      ) => {
        // Create a Map
        const map = new Map({ basemap: 'topo-vector' });

        // Make map view and bind it to the map
        const view = new MapView({
          container: 'viewDiv',
          map: map,
          center: [-117.195743, 34.057025],
          zoom: 18,
          popup: new Popup({
            dockEnabled: true,
            dockOptions: {
              // Disables the dock button from the popup
              buttonEnabled: false,
              // Ignore the default sizes that trigger responsive docking
              breakpoint: false,
            },
            visibleElements: {
              closeButton: true,
            },
          }),
          container: 'viewDiv',
        });

        /********************************************************************
         * Add a vector tile layer to the map
         *
         * The url must point to the style or the vector tile service
         *********************************************************************/
        const tileLayer = new VectorTileLayer({
          portalItem: {
            id: '529766b680754596854a381e772063ca',
          },
        });
        map.add(tileLayer);
        // Initial points location
        const points = {
          0: { longitude: -117.196357, latitude: 34.057036 },
          1: { longitude: -117.196357, latitude: 34.057036 },
          2: { longitude: -117.1963897, latitude: 34.0570364 },
        };

        const markerSymbols = {
          0: {
            type: 'simple-marker',
            color: [226, 119, 40], // orange
            outline: {
              color: [255, 255, 255],
              width: 2,
            },
          },
          1: {
            type: 'simple-marker',
            color: [0, 119, 255], // blue
            outline: {
              color: [255, 255, 255],
              width: 2,
            },
          },
        };

        const pointGraphics = {
          0: new Graphic({
            geometry: { type: 'point', longitude: points[0].longitude, latitude: points[0].latitude },
            symbol: markerSymbols[0],
          }),
          1: new Graphic({
            geometry: { type: 'point', longitude: points[1].longitude, latitude: points[1].latitude },
            symbol: markerSymbols[0],
          }),
          2: new Graphic({
            geometry: { type: 'point', longitude: points[2].longitude, latitude: points[2].latitude },
            symbol: markerSymbols[1],
          }),
        };

        view.graphics.addMany(Object.values(pointGraphics));

        // WebSocket integration
        const ws = new WebSocket('ws://localhost:8000/ws');

        ws.onopen = function (event) {
          console.log('WebSocket is open now.');
        };

        ws.onmessage = function (event) {
          console.log('WebSocket Received:', event.data);
          const data = JSON.parse(event.data);
          updateLocation(data.object_id, data.direction);
        };

        ws.onclose = function (event) {
          console.log('WebSocket is closed now.');
        };

        ws.onerror = function (error) {
          console.log('WebSocket Error:', error);
        };

        function updateLocation(object_id, direction) {
          let point = points[object_id];

          console.log(`[${object_id}] latitude: ${point.latitude} longitude: ${point.longitude}`);

          switch (direction) {
            case 'left':
              point.longitude -= 0.001; // Adjust the value as needed
              break;
            case 'right':
              point.longitude += 0.001; // Adjust the value as needed
              break;
            case 'up':
              point.latitude += 0.001; // Adjust the value as needed
              break;
            case 'down':
              point.latitude -= 0.001; // Adjust the value as needed
              break;
          }

          pointGraphics[object_id].geometry = {
            type: 'point',
            longitude: point.longitude,
            latitude: point.latitude,
            spatialReference: { wkid: 4326 },
          };

          view.graphics.removeAll();
          view.graphics.addMany(Object.values(pointGraphics));
        }

        view.popupEnabled = false;
        view.on('click', function (event, index) {
          // Check if a graphic was clicked
          Object.values(pointGraphics).forEach((point, index) => {
            console.log(point);
            if (Math.abs(event.mapPoint.latitude - point.geometry.latitude) < 0.00001 && Math.abs(event.mapPoint.longitude - point.geometry.longitude) < 0.00001) {
              view.openPopup({
                // Set the popup's title to the coordinates of the location
                title: 'Camera #' + index,
                content: event.mapPoint, // Set the location of the popup to the clicked location
              });
            }
          });
        });
      });
    </script>
  </head>
  <body>
    <div id="viewDiv"></div>
  </body>
</html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>VectorTileLayer | Sample | ArcGIS Maps SDK for JavaScript 4.30</title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      .esri-popup-container {
        width: 400px;
        height: 300px;
      }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.30/"></script>
    <script>
      require(['esri/Map', 'esri/views/MapView', 'esri/layers/VectorTileLayer', 'esri/Graphic', 'esri/layers/GraphicsLayer', 'esri/widgets/Popup'], (
        Map,
        MapView,
        VectorTileLayer,
        Graphic,
        GraphicsLayer,
        Popup,
      ) => {
        // Create a Map
        const map = new Map({ basemap: 'topo-vector' });

        // Make map view and bind it to the map
        const view = new MapView({
          container: 'viewDiv',
          map: map,
          center: [-117.195743, 34.057025],
          zoom: 18,
          popup: new Popup({
            dockEnabled: true,
            dockOptions: {
              // Disables the dock button from the popup
              buttonEnabled: false,
              // Ignore the default sizes that trigger responsive docking
              breakpoint: false,
            },
            visibleElements: {
              closeButton: true,
            },
          }),
          container: 'viewDiv',
        });

        /********************************************************************
         * Add a vector tile layer to the map
         *
         * The url must point to the style or the vector tile service
         *********************************************************************/
        const tileLayer = new VectorTileLayer({
          portalItem: {
            id: '529766b680754596854a381e772063ca',
          },
        });
        map.add(tileLayer);
        // Initial points location
        const points = {
          0: { longitude: -117.196357, latitude: 34.057033 },
          1: { longitude: -117.196357, latitude: 34.057033 },
          2: { longitude: -117.1963897, latitude: 34.057035 },
        };

        const markerSymbols = {
          0: {
            type: 'simple-marker',
            color: [226, 119, 40], // orange
            outline: {
              color: [255, 255, 255],
              width: 2,
            },
          },
          1: {
            type: 'simple-marker',
            color: [0, 119, 255], // blue
            outline: {
              color: [255, 255, 255],
              width: 2,
            },
          },
        };

        const pointGraphics = {
          0: new Graphic({
            geometry: { type: 'point', longitude: points[0].longitude, latitude: points[0].latitude },
            symbol: markerSymbols[0],
          }),
          1: new Graphic({
            geometry: { type: 'point', longitude: points[1].longitude, latitude: points[1].latitude },
            symbol: markerSymbols[0],
          }),
          2: new Graphic({
            geometry: { type: 'point', longitude: points[2].longitude, latitude: points[2].latitude },
            symbol: markerSymbols[1],
          }),
        };

        view.graphics.addMany(Object.values(pointGraphics));

        // WebSocket integration
        const ws = new WebSocket('ws://localhost:8000/ws');

        ws.onopen = function (event) {
          console.log('WebSocket is open now.');
        };

        ws.onmessage = function (event) {
          console.log('WebSocket Received:', event.data);
          const data = JSON.parse(event.data);
          updateLocation(data.object_id, data.direction);
        };

        ws.onclose = function (event) {
          console.log('WebSocket is closed now.');
        };

        ws.onerror = function (error) {
          console.log('WebSocket Error:', error);
        };

        function updateLocation(object_id, direction) {
          let point = points[object_id];

          console.log(`[${object_id}] latitude: ${point.latitude} longitude: ${point.longitude}`);

          switch (direction) {
            case 'left':
              point.longitude -= 0.00002; // Adjust the value as needed
              break;
            case 'right':
              point.longitude += 0.00004; // Adjust the value as needed
              break;
            case 'up':
              point.latitude += 0.00003; // Adjust the value as needed
              break;
            case 'down':
              point.latitude -= 0.00004; // Adjust the value as needed
              break;
          }

          pointGraphics[object_id].geometry = {
            type: 'point',
            longitude: point.longitude,
            latitude: point.latitude,
            spatialReference: { wkid: 4326 },
          };

          view.graphics.removeAll();
          view.graphics.addMany(Object.values(pointGraphics));
        }

        view.popupEnabled = false;
        view.on('click', function (event, index) {
          // Check if a graphic was clicked
          Object.values(pointGraphics).forEach((point, index) => {
            console.log(point);
            if (Math.abs(event.mapPoint.latitude - point.geometry.latitude) < 0.00001 && Math.abs(event.mapPoint.longitude - point.geometry.longitude) < 0.00001) {
              view.openPopup({
                // Set the popup's title to the coordinates of the location
                title: index === 2 ? 'Camera' : 'Human Count = ' + (index + 1),
                content: '\n\n\n\n\n\n\n\n\n\n\n\n\n\n', // Set the location of the popup to the clicked location
              });
            }
          });
        });
      });
    </script>
  </head>
  <body>
    <div id="viewDiv"></div>
  </body>
</html>
